(function(e,a,t,n){var r=function(){var e=!(!t.URL&&!t.webkitURL);return e&&Modernizr.getusermedia&&Modernizr.webgl}(),o=function(e,a,t){return navigator.getUserMedia?navigator.getUserMedia(e,a,t):navigator.webkitGetUserMedia?navigator.webkitGetUserMedia(e,a,t):navigator.mozGetUserMedia?navigator.mozGetUserMedia(e,a,t):navigator.msGetUserMedia?navigator.msGetUserMedia(e,a,t):(t(Error("webcom is not available")),void 0)},i=t.URL||t.webkitURL,s=800,c=600,d=400/Math.max(s,c);if(a(t),!r)return a(function(){a(".c4u-help").addClass("c4u-help--hasError"),a(".c4u-help-error1").css({display:"block"})}),void 0;var h=function(){$container=a("#experiment"),$container.css({width:s,height:c}),$streamVideo=a("#stream"),$streamVideo.attr({width:s,height:c,loop:!0,volume:0,autoplay:!0,controls:!1}),o({video:!0,audio:!1},function(e){$streamVideo[0].src=i.createObjectURL(e)},function(){a(".c4u-help").addClass("c4u-help--hasError"),a(".c4u-help-error2").css({display:"block"})}),$canvas2d=a(n.createElement("canvas")),$canvas2d.attr({width:s*d,height:c*d}),context2d=$canvas2d[0].getContext("2d"),$canvas3d=a("#canvas3d"),detector=new AR.Detector,posit=new POS.Posit(1,s),scene=new e.Scene,camera=new e.PerspectiveCamera(40,s/c,1,1e3),renderer=new e.WebGLRenderer({canvas:$canvas3d[0],preserveDrawingBuffer:!0,alpha:!0}),renderer.setSize(s,c);var t=new e.AmbientLight(13421772);scene.add(t);var r=new e.DirectionalLight(16777164);r.position.set(0,-1,0),scene.add(r),meshContainer=new e.Object3D,scene.add(meshContainer)},l=function(){var t=new a.Deferred,n=new e.JSONLoader;return n.load("./assets/3dmodel/chocolate/chocolate.js",function(a,n){for(var r=0,o=n.length;o>r;r++)n[r].side=e.DoubleSide;mesh=new e.Mesh(a,new e.MeshFaceMaterial(n)),mesh.rotation.x=e.Math.degToRad(90),mesh.scale.set(16,16,16),meshContainer.add(mesh),t.resolve()}),t.promise()},u=function(){requestAnimationFrame(u);try{context2d.drawImage($streamVideo[0],0,0,s*d,c*d)}catch(e){return}var a=context2d.getImageData(0,0,s*d,c*d),t=detector.detect(a);if(0!==t.length){for(var n=t[0].corners,r=0,o=n.length;o>r;r++)corner=n[r],corner.x=corner.x-s*d/2,corner.y=c*d/2-corner.y;var i=posit.pose(n),h=i.bestRotation,l=i.bestTranslation;meshContainer.rotation.set(-Math.asin(-h[1][2]),-Math.atan2(h[0][2],h[2][2]),Math.atan2(h[1][0],h[1][1])),meshContainer.position.set(l[0],l[1],-l[2]),renderer.render(scene,camera)}},m=function(){var e=new a.Deferred,t="c4u-help--checked",n=a(".c4u-help"),r=a("#playButton");return r.one("click",function(){n.addClass(t),r.fadeOut(),e.resolve()}),e.promise()},v=function(){var e=new a.Deferred;return t.addEventListener("load",function(){e.resolve()}),e.promise()};h(),a.when(m(),l(),v()).done(function(){u()}),a(function(){var e=a(".c4u-pageHeader-info"),t=e.find(".c4u-pageHeader-infoButton"),n=e.find(".c4u-pageHeader-infoBody");t.on("click",function(){n.slideToggle()})}),a(function(){var e=a(n.createElement("canvas"));e.attr({width:s,height:c});var r=e[0].getContext("2d");a("#takephoto").on("click",function(){e[0].width=e[0].width;var a=new Image;a.src=$canvas3d[0].toDataURL("image/png"),r.drawImage($streamVideo[0],0,0,s,c),r.drawImage(a,0,0,s,c);var n=e[0].toDataURL("image/png"),o=["data:text/html,",'<body style="margin:0;padding:0;">','<img src="',n,'"/>'].join("");t.open(o,"","width="+s+", height="+c+", menubar=no, toolbar=no, scrollbars=yes")})})})(THREE,jQuery,window,document);